<!DOCTYPE html>
<html>
 <head>
 	  <title>Lao Water Supply </title>
   <link rel="stylesheet" href="leaflet-0.7.3/leaflet.css" />
   <script src="jquery-ui-1.11.0/external/jquery/jquery.js"></script>
    <script src="jquery-ui-1.11.0/jquery-ui.js"></script>
   <script src="leaflet-0.7.3/leaflet.js"></script>
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <!-- <link href="http://akvo.org/wp-content/themes/Akvo-responsive/favicon.ico" rel="shortcut icon"> -->
   <link rel="stylesheet" href="jquery-ui-1.11.0/jquery-ui.css" />
   <link rel="stylesheet" href="jquery-ui-1.11.0/jquery-ui.structure.css" />
   <link rel="stylesheet" href="jquery-ui-1.11.0/jquery-ui.theme.css" />
   <link rel="stylesheet" href="mobile.css" />
   <link rel="stylesheet" href="dist/MarkerCluster.css" />
	<link rel="stylesheet" href="dist/MarkerCluster.Default.css" />
	<link rel="stylesheet" href="community.css" />
	<link rel="stylesheet" href="clusterpie.css" />
	<script src="dist/leaflet.markercluster-src.js"></script>
	<script src="https://maps.google.com/maps/api/js?v=3&sensor=false"></script>
	<script src="layer/tile/Google.js"></script>
	
	<script src="filter.js"></script>
	<script src="lao1.js"></script>
	<script src="lao2.js"></script>
	<script src="a.js"></script>
	<script src="p.js"></script>
	
	<!-- // <script src="html5slider.js"></script> -->
 </head>
<style type="text/css">
    </style>
  </head>
  <body>

<div id="map"></div>

<div id='controlpanel' class='draggable ui-corner-all ui-widget-content uipanel'>
			<h3>Data Chooser</h3>
			<div id='controlpanelcontent'>
				<!-- <div id='schoolCode'>
					<label for="code">School Code</label>
					<input type='text' id='code' size=15 class="textbox"></input>
					<input id="Search" type="button" value="Go to School" ></input>	
				</div> -->
				
				<div id='topiclist' class='controlpaneloption'><!-- 1.<div id='topicbuttons'></div> -->
				</div>
				<div id='tablelist' class='controlpaneloption'>
				<label for="1">District</label>
				 <select id="1">
				
				</select>
				<label for="2">Kumban</label>
				<select id="2">
					
				</select>
					
				</div>
				<!-- <div>
				<label for="3">RWS Type</label>
					<select id="3">
				</div> -->
				<div id='tablelist' class='controlpaneloption'>
				<label for="3">RWS Type</label>
					<select id='3' class='ui-widget select'></select>
					
				</div>
				<div id='tablelist' class='controlpaneloption'>
				<label for="4">Indicator</label>
					<select id='4' class='ui-widget select'></select>
					<input id="Go" type="button" value="Search" ></input>
				</div>
				<!-- <div id='tablequal' class='qual'>&nbsp;</div>
				<div id='collist' class='controlpaneloption'>3
					<select id='colselect' onchange='setSubCols()'></select>
				</div>
				<div id='subcollist' class='controlpaneloption'>4
					<select id='subcolselect' onchange='setColQualAndTileNames()'></select>
				</div> -->
				<div id='colqual' class='qual'><label id='tooltip'></label>&nbsp;</div>
			</div>
		</div>
		<div id='infopanel' class="draggable ui-corner-all ui-widget-content uipanel">
			<h3>Key</h3>
			<div id='infopanelcontent'>
				<div id='colpanel'>
				</div>
				
				<div id='keypanel'>
					<div id='keylqs'>
					</div>
					<div id='keyitems'>
					</div>
					<div id='keynumbers'>
					</div>
				</div>
				<div id='placepanel'>
				</div>
				<div style='clear: both; '></div>
			</div>
		</div>
       <script src="lib/d3.v3.min.js" charset="utf-8"></script>

      <script type="text/javascript">
 
d3.csv("raw_data.csv",function(data){
var origData=data;
var baselayer;
var districtLayer;
var schoolMarker;
var schoolMarkerAdded=false;
var currentIndicator="";
var legendAdded=false;
var rmax=30;
var map = L.map('map',{zoomControl: false,maxZoom:15 }).setView([16.399708, 105.614019], 8);

// var osm = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
var ggl = new L.Google();
var ggl2 = new L.Google('TERRAIN');
	map.addLayer(ggl2);
	var baseMaps={'Satellite':ggl, 'Google Terrain':ggl2};
	map.addControl(new L.Control.Layers( baseMaps, {}));
	baselayer=L.geoJson(lao1,{style:style});
	baselayer.addTo(map);
	districtLayer=L.geoJson(lao2,{style:style});
	// districtLayer.addTo(map);
	L.geoJson(a,{style:style}).addTo(map);
	L.geoJson(p,{style:style}).addTo(map);
	new L.control.zoom({position:'bottomright'}).addTo(map);
 	// map.on('zoomend',update);
 	$("#controlpanel").accordion({ collapsible: true, heightStyle: "content"}).draggable({ snap: true, snapTolerance: 6, scroll: false, distance: 10, cursorAt: { top: 30, left: 290 } });
 	$("#infopanel").accordion({ collapsible: true, heightStyle: "content"}).draggable({ snap: true, snapTolerance: 6, scroll: false, cursorAt: { top: 30, left: 105 } });
 	var areas=getAreas();
 	// createRadioButtons('topicbuttons');
 	populateFilterCombo(null,null,'#1','District');
 	populateFilterCombo('All','District','#2','Kumban');
 	populateFilterCombo(null,null,'#3','RWS type');
 	populateCombo("RTE Indicators","#4");
 	L.control.scale({position: 'bottomleft',maxWidth:400,imperial:false}).addTo(map);



function createRadioButtons(id){
	var html=""
	$.each(areas,function(i,value){
    		html += '<input type="radio" id="'+id+value + '" name="'+id+'"><label for="'+id+value + '">' + value + "</label>";
  
		});
	$( "#"+id ).buttonset()
	$("#"+id).append(html);

}
// $( "#topicbuttons" ).buttonset('refresh').find(':radio[name=topicbuttons]').click( function() 
// 	{  
// 		populateCombo($(this).attr("id").substring(12),"#4");
// 		$("#colqual").empty();

// 	});
// Removes/adds the organge highlight
 function update(){
 	var zoom=map.getZoom();
 	if(zoom>=11){
 		map.removeLayer(gjLayer);
 	}else if(!map.hasLayer(gjLayer)){
 		gjLayer.addTo(map);
 	}

 }

function getAreas(){
	var map3={};
 		
 	for(var j=0;j<filterStruct.length;j++){
 		var name3=filterStruct[j].Area;
 		if(!(name3 in map3)){
 			map3[name3]=name3;
 		}
 	};
 	return map3;


}

function onEachFeature(feature, layer) {
    layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: zoomToFeature
    });
}
function highlightFeature(e) {
    var layer = e.target;

    layer.setStyle({
        weight: 1,
        color: 'red',
        dashArray: ''
        // fillOpacity: 0.7
    });

    if (!L.Browser.ie && !L.Browser.opera) {
        layer.bringToFront();
    }
    // info.update(layer.feature.properties);
}
function resetHighlight(e) {
    gjLayer.resetStyle(e.target);
    // info.update();
}
function zoomToFeature(e) {
    map.fitBounds(e.target.getBounds());
}
var info = L.control();

// info.onAdd = function (map) {
//     this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
//     this.update();
//     return this._div;
// };

// // method that we will use to update the control based on feature properties passed
// info.update = function (props) {
//     this._div.innerHTML = '<h4>TALUK</h4>' +  (props ?'<b>' + props.NAME_3 + '</b><br />': 'Hover over a taluk');
// };

// info.addTo(map);
function style(feature) {
    return {
        fillColor: '#ef9400',
        weight: 2,
        opacity: .5,
        color: 'brown',
        dashArray: '2',
        fillOpacity: 0.001
    };
}

var markers = L.markerClusterGroup({spiderfyOnMaxZoom: true, showCoverageOnHover: true, zoomToBoundsOnClick: true});
				var markerList = [];

		var markerIcon= L.Icon.extend({
			options:{
    							
    							iconSize:     [32, 32] ,// size of the icon
							    shadowSize:   [41, 41], // size of the shadow
							    popupAnchor:  [-3, -15] // point from which the popup should open relative to the iconAnchor
}
});

var greenIcon=new markerIcon({iconUrl:"green.png"});
var redIcon=new markerIcon({iconUrl:"red.png"});
var brownIcon=new markerIcon({iconUrl:"brown.png"});
var blueIcon=new markerIcon({iconUrl:"blue.png"});
var yellowIcon=new markerIcon({iconUrl:"yellow.png"});
var emeraldIcon=new markerIcon({iconUrl:"emerald.png"});
var orangeIcon=new markerIcon({iconUrl:"orange.png"});



		function populate(val1,val2,val3,val4,val5) {
			var data;
			if(val1==null && val2==null && val3==null && val4==null && val5==null){
				data=origData;
				// for(var j=0;j<data.length;j++){
				// var counter=0;
				//  			$.each(getIndicators("RTE Indicators",false),function(i,value){
				//  				if(data[j][value]=="Yes"){
				 					
				//  					counter=counter+1;

				//  				}
				    				
				//     				});
				//  				console.log(data[j]["School"]+"--"+counter);

				//  			}
				createAndPushMarkers(data);
			}else if(val5==null){
				data=filter(val1,"District",origData);
				data=filter(val2,"Kumban",data);
				data=filter(val3,"RWS type",data);
				// data=filterNA(data);
				createAndPushMarkers(data,val4,val5)
			}else if(val5!=null){
				data=filter(val1,"District",origData);
				data=filter(val2,"Kumban",data);
				data=filter(val3,"RWS type",data);
				// data=filterNA(data);
				data=filterOnSelection(val5,data);
				createAndPushMarkers(data,val4,val5);

			}
			
			
		
			map.addLayer(markers);
			if(markers.toGeoJSON().features.length==0){
				alert("No matches found for this filter");
			}

		}

		populate();
		function createAndPushMarkers(data,val4,val5){
			
			for(var j=0;j<data.length;j++){
			var marker=L.marker(L.latLng(data[j].Lat, data[j].Lon), { alt:data[j][currentIndicator],icon: getIcon(data[j],val4,val5)});
			marker.bindPopup('<div style="padding:0px;font-size:12px;"><table border="0" cellpadding="1" cellspacing="0" style="width: 250px;border-style:outset;border-color:#000000;"><tbody><tr><td><a target="_blank" href='+data[j]["Photo of Source"]+'><img  src='+data[j]["Photo of Source"] +' style="width: 250px; height:130px"/></a><p><b>Functionality :</b>'+ data[j].Functionality+'</p><p><b>Age :</b>'+ data[j].Age+'</p><p><b>Quality :</b>'+ data[j].Quality+'</p><p><b>Quantity :</b>'+ data[j].Quantity+'</p><p><b>Accessibility :</b>'+ data[j].Accessibility+'</p><p><b>Reliability :</b>'+ data[j].Reliability+'</p><p><b>Kumban :</b>'+data[j].Kumban+'</p><p><b>Source :</b>'+ data[j]['RWS type'] +'</p><p><b>Unique ID :</b>'+ data[j]["Geo code"] +'</p></td></tr></tbody></table></div>');

						markers.addLayer(marker);
				markerList.push(marker);

			}

		}

		function getIcon(data,val4,val5){
			if(val4==null){
				return blueIcon;
			}else if (val4!=null){
				var key=data[currentIndicator];
				var type=data["RWS type"];
				var attributes=getLegendAttributes(currentIndicator);
				var iconAttributes=getIconAttributes(currentIndicator);
				var iconPNG=iconAttributes[attributes.indexOf(key)];
				return new markerIcon({iconUrl:'png/'+type.substr(0,1)+'c'+iconPNG});

			}


		}
		function filterNA(data){
			var modData=[];
			for(var i=0;i<data.length;i++){
					if(data[i][currentIndicator]!="NA"){
						modData.push(data[i]);
					}
				}
				return modData;

		}
		function filterOnSelection(val5,data){

			var modData=[];
			for(var i=0;i<data.length;i++){
					if(val5==data[i][currentIndicator]){
						modData.push(data[i]);

					}else if(val5=="All"){
						modData=data;
						break;
				}
		}
		return modData;
	}

// function addMarkers(data,icon,column,boolean){
// 				var marker;
// 				var markers = L.markerClusterGroup({spiderfyOnMaxZoom: true, showCoverageOnHover: true, zoomToBoundsOnClick: true,maxClusterRadius:50,iconCreateFunction:defineClusterIcon});
// 				var markerList = [];

// 				for (var i = 0; i < data.length; i++) {
// 					if(column!=null  && data[i][column]==boolean){
// 						marker = createMarker(data[i],icon);
// 						markers.addLayer(marker);
// 						markerList.push(marker);
// 					}
// 					if(column==null){
// 						 marker = createMarker(data[i],icon);
// 						 markers.addLayer(marker);
// 						markerList.push(marker);
// 					}
				
				 
				
				
// 			}
// 			return markers;


// }	

// function createMarker(dataElement,icon){

	
				
// 				return marker;
// }	

	

function filter(val,column,dataToFilter){
	var modData=[];
for(var i=0;i<dataToFilter.length;i++){
	if(val==dataToFilter[i][column]){
		modData.push(dataToFilter[i]);

	}else if(val=="All"){
		modData=dataToFilter;
		break;
	}


}
return modData;
}
function filterSource(d,type){
	var modData=[];
	for(var i=0;i<=d.length;i++){
		if (d[i] !=undefined){
			if(d[i].Type==type){
					modData.push(d[i]);
			}else if(type=="All" && (d[i].Type)!=null){
					modData=d;
					break;
			}

		}

    }

return modData;
}
function filterYear(d,year){
	var modData=[];
	for(var i=0;i<=d.length;i++){
		if (d[i] !=undefined){
			if(d[i].Year==year){
					modData.push(d[i]);
			}else if(year=="2012"){
				modData=d;
				break;
			}

		}

    }

return modData;
}

var legend = L.control({position: 'bottomleft'});

legend.onAdd = function (map) {
	var attributes=getLegendAttributes(currentIndicator);
	var iconAttributes=getIconAttributes(currentIndicator);
    var div = L.DomUtil.create('div', 'infoLegend');
    div.innerHTML=getLegendHTML(attributes,iconAttributes);/*'<h4>Toilet Users</h4><p><input name="RD1" type="radio" id="filter" value="5">0-5</p><p><input name="RD1"type="radio" id="filter" value="10"/>6-10</p><p><input name="RD1"type="radio" id="filter" value="10+"/>10+</p><p><input name="RD1"type="radio" id="filter" value="All"/>All</p><p><input name="RD1"type="radio" id="filter" value="Blanks"/>Blanks</p>';*/
   legendAdded=true;
   
    return div;
};
function getLegendHTML(attributes,iconAttributes){
	if(attributes==""){
		return "";
	}else{
		var htmlStr='';
		for(var j=0;j<attributes.length;j++){
			htmlStr=htmlStr+'<p><img src=png/'+iconAttributes[j]+'><input name="RD1" type="radio" id="filter"  value="'+attributes[j]+'"/>'+attributes[j]+'</p>'

		}
		return htmlStr;

	}

}

function getLegendAttributes(currentIndicator){
	if(currentIndicator==""){
		return "";
	}else{
		var attributes=[];
	for(var j=0;j<filterStruct.length;j++){
 		var name2=filterStruct[j].Indicator;
 		// var legend= filterStruct[j].Legend;
 		if(name2==currentIndicator){
 			attributes=filterStruct[j].Legend.split("/");
 			return attributes;
 		}



}
}
}
function getIconAttributes(currentIndicator){
	if(currentIndicator==""){
		return "";
	}else{
		var attributes=[];
	for(var j=0;j<filterStruct.length;j++){
 		var name2=filterStruct[j].Indicator;
 		// var legend= filterStruct[j].Legend;
 		if(name2==currentIndicator){
 			attributes=filterStruct[j].Icon.split("/");
 			return attributes;
 		}



}
}
}
function getSchool(id){
	for(var j=0;j<origData.length;j++){
		if(origData[j].School_Code==id){
			return origData[j];
		}
	}
}
$('body').on('click','.linktext',function(e){
	var id=this.id;
	var record=getSchool(id);
		$myWindow = jQuery('#myDiv');

    		//instantiate the dialog
        	$myWindow.dialog({ height: 350,
           		width: 775,
           		modal: true,
           		position: 'center',
           		autoOpen:false,
           		// title:record.School,
           		close: CloseFunction,
           		overlay: { opacity: 0.5, background: 'black'}
           		});
        	$myWindow.show();
        	
        	$myWindow.html('<div id=dialogList></div>');
        	// createRadioButtons('dialogList');
        	$( "#dialogList").append('<div id=questions ></div>')
        	$myWindow.dialog("open");
 			// $( "#dialogList").buttonset('refresh').find(':radio[name=dialogList]').click( function() 
				// {  
					$('#questions').empty();
					var indicator=$(this).attr("id").substring(10);

					var html="";
					if(indicator=="RTE Indicators"){
						$('#questions').append('<p>Composite RtE rating: <b>'+record["Rating"]+'</b> </p>');
						// $.each(getIndicators(indicator,false),function(i,value){
    		// 		html += '<p>'+value+': <b>'+record[value]+'</b> </p>';
    		// 		$('#questions').html(html);

					// });
				 			html='<div class="datagrid"><table> <thead> <tr> <th>RTE Norms Conformity</th> </tr> </thead>';
				 			var tbody='<tbody>';
				 			var counter=0;
				 			$.each(getIndicators(indicator,false),function(i,value){
				 				if(record[value]=="Yes"){
				 					tbody += '<tr class="alt"> <td>'+value+'</td> </tr>';
				 					counter=counter+1;

				 				}
				    				
				    				});
				 				console.log(record["School"]+'-------'+counter);
				 			$.each(getIndicators(indicator,false),function(i,value){
				 				if(record[value]=="No"){
				 					tbody += '<tr class="alt1"> <td>'+value+'</td> </tr>';

				 				}
				    				
				    				});
				 			tbody += '</tbody>';
				 			html+=tbody;
				 			html+='</table></div>'

				 			 $('#questions').append(html);
					}else if(indicator=="Attendance"){
					// var indicators=getPopupIndicators(indicator);
					var d3data=[];
					var d3Obj={"Date":record["Date"],"Girls":record["Girls"],"Boys":record["Boys"],"Total":record["Total"]};
					d3data.push(d3Obj);
					var blank={"Date":"","Girls":""};
					d3data.push(blank);
					blank={"Date":"-","Girls":""};
					d3data.push(blank);
					blank={"Date":".","Girls":""};
					d3data.push(blank);
					var color=["#dd1c77", "#43a2ca", "#31a354"];
					$('#questions').append(attendanceGraph(d3data,"Attendance %",color,100));
					$('#questions').append('<br/>')
					d3Obj={};
					d3data=[];
					d3Obj={"Date":record["Date"],"Girls":record["Girls enrolled"],"Boys":record["Boys enrolled"],"Total":record["Total students"]};
					d3data.push(d3Obj);
					blank={"Date":"","Girls":""};
					d3data.push(blank);
					blank={"Date":"-","Girls":""};
					d3data.push(blank);
					blank={"Date":".","Girls":""};
					d3data.push(blank);
					$('#questions').append(attendanceGraph(d3data,"Enrollment",color));

    
   
				}else if(indicator=="Adequacy of teacher"){
					// var indicators=getPopupIndicators(indicator);
					$('#questions').append('<p>Special counsellors for CWSN in school/circle: <b>'+record["Special counsellors for CWSN in school/circle"]+'</b> </p>');
					var d3data=[];
					var d3Obj={"Date":record["Date"],"Teachers attendance":record["Teachers attendance"],"% Sanctioned appointed":record["Sanctioned Teachers appointed"],"In-Service Training":record["In-service training"]};
					d3data.push(d3Obj);
					var blank={"Date":"","Teachers attendance":"","Sanctioned teachers appointed":"","In-Service Training":""};
					d3data.push(blank);
					var blank1={"Date":"-","Teachers attendance":"","Sanctioned teachers appointed":"","In-Service Training":""};
					d3data.push(blank1);
					blank1={"Date":".","Teachers attendance":"","Sanctioned teachers appointed":"","In-Service Training":""};
					d3data.push(blank1);
					var color=["#f03b20", "#feb24c", "#ffeda0"];
					$('#questions').append(attendanceGraph(d3data,"%",color,100));
					$('#questions').append('<br/>');
					$('#questions').append('<div><b>Teacher Distribution</b></div>');
					var pieData=[];
					var piedataObjPerm={};
					piedataObjPerm["key"]="Permanent";
					piedataObjPerm["value"]=parseInt(record["Total teachers appointed (permanent) in the school"]);
					var otherTeachers=parseInt(record["Total appointed permanent teachers and other teachers"])-parseInt(record["Total teachers appointed (permanent) in the school"]);
					var piedataObjNPerm={};
					piedataObjNPerm["key"]="Non-permanent";
					piedataObjNPerm["value"]=otherTeachers;
					pieData.push(piedataObjPerm);
					pieData.push(piedataObjNPerm);
					

					// bakeThePie({data: data,
     //                        valueFunc: function(d){return d.values.length;},
     //                        strokeWidth: 1,
     //                        outerRadius: r,
     //                        innerRadius: r-10,
     //                        pieClass: 'cluster-pie',
     //                        pieLabel: n,
     //                        pieLabelClass: 'marker-cluster-pie-label',
     //                        pathClassFunc: function(d)
     //                        {var value=d.data.key;
     //                        	// if(value=="Yes"){
     //                        	// 	return 'category-3';
     //                        	// }
     //                            var iconattributes=getIconAttributes(currentIndicator);
     //                            var legendAttributes=getLegendAttributes(currentIndicator);
     //                            var suffix=iconattributes[legendAttributes.indexOf(value)].split(".");
     //                            return "category-"+suffix[0];

     //                        },
     //           pathTitleFunc: function(d){return d.data.key+' ('+d.data.values.length+')'+'('+percentages[d.data.key]+'%)'}
     //                      }),
					var percent=getPercentage(parseInt(record["Total appointed permanent teachers and other teachers"]),pieData);
					$('#questions').append(pie({
												data:pieData,
												valueFunc: function(d){return d.value;},
												strokeWidth: 1,
                            					// outerRadius: 100,
                           					 //    innerRadius: 70,
                           					 	Total:parseInt(record["Total appointed permanent teachers and other teachers"]),
                            					pieClass: 'cluster-pie',
                            					pieLabel: record["Total appointed permanent teachers and other teachers"],
                            					pieLabelClass: 'marker-cluster-pie-label',
                            					
                            					pathClassFunc: function(d)
                            							{var value=d.data.key;
                            								if(value=="Permanent"){
                            									return "category-3";
                            								}else{
                            									return "category-1";
                            								}

                            							},
                            							
                            							 pathTitleFunc: function(d){return d.data.value+' ('+percent[d.data.key]+'%)'},
                            							 title:function(d){
                            							 		var value=d.data.key;
                            							 		if(percent[value]=="0"){
                            							 			return "";
                            							 		}else{


                            							 	return d.data.key
                            							 }
                            							}



											}));

					
    					
   
				}else if(indicator=="WASH infrastructure"){
					$.each(getPopupIndicators(indicator,false),function(i,value){
    				html += '<p>'+value+': <b>'+record[value]+'</b> </p>';
    				$('#questions').html(html);

					});
					var d3data=[];
					var d3Obj={"Date":record["Date"],"Urinal":record["How many urinals does the school have"],"Toilet":record["How many toilets does the school have"],"Total":record["Total toilets + urinals"]};
					d3data.push(d3Obj);
					var blank={"Date":""};
					d3data.push(blank);
					var blank1={"Date":"-"};
					d3data.push(blank1);
					blank1={"Date":"."};
					d3data.push(blank1);
					var color=["#f03b20", "#feb24c", "#ffeda0"];
					$('#questions').append(attendanceGraph(d3data,"",color));

					d3data=[];
					d3Obj={};
					d3Obj={"Date":record["Date"],"Male":record["Total number of toilets for male teachers"],"Female":record["Total number of toilets for female teachers"],"Total":record["Total Toilets for teachers"]};
					d3data.push(d3Obj);
					blank={"Date":"","Male":""};
					d3data.push(blank);
					blank={"Date":".","Male":""};
					d3data.push(blank);
					blank={"Date":"-","Male":""};
					d3data.push(blank);
					color=[];
					color=["#f03b20", "#feb24c", "#ffeda0"];
					$('#questions').append("<br/>");
					$('#questions').append(attendanceGraph(d3data,"Teacher toilets",color));


    
   
				}else if(indicator=="School Management"){
					$.each(getPopupIndicators(indicator,false),function(i,value){
    				html += '<p>'+value+': <b>'+record[value]+'</b> </p>';
    				$('#questions').html(html);

					});
					var d3data=[];
					var d3Obj={"Date":record["Date"],"MTA conducted":record["MTA conducted in the last 12 months"]};
					d3data.push(d3Obj);
					var blank={"Date":"","MTA conducted":""};
					d3data.push(blank);
					var blank1={"Date":".","MTA conducted":""};
					d3data.push(blank1);
					blank1={"Date":"-","MTA conducted":""};
					d3data.push(blank1);
					var color=["#f03b20"];
					$('#questions').append(attendanceGraph(d3data,"",color,12));


    
   
				}else if(indicator=="School Funds"){
					// $.each(getPopupIndicators(indicator,false),function(i,value){
    	// 			html += '<p>'+value+': <b>'+record[value]+'</b> </p>';
    	// 			$('#questions').html(html);

					// });
					var d3data=[];
					var d3Obj={"Date":record["Date"],"New building":record["New school buildings"],"Adnl. classroom":record["Additional classroom"],"Sanitation":record["Sanitation facilities/toilets"],"Water":record["Drinking water facilities"],"Library":record["Library"],"Incinerator":record["Incinerator"],"TLM":record["Teaching learning material"],"Maint.":record["Maintenance"],"School Dev grant":record["School Development grant"]};
					d3data.push(d3Obj);
					var blank={"Date":record["Date"],"New building":record[""]}
					d3data.push(blank);
					var blank1={"Date":".","New building":record[""]}
					d3data.push(blank1);
					blank1={"Date":"-","New building":record[""]}
					d3data.push(blank1);
					var color=["#2ca25f","#8856a7","#43a2ca","#e34a33","#feb24c","#c51b8a","#ffeda0","#1c9099","#636363"];
					$('#questions').append(attendanceGraph(d3data,"",color));


    
   
				}			
				// });;




        	}
		
		);
function CloseFunction(){

	$('#myDiv').empty();
}
function isEven(n) {
  return n == parseFloat(n)? !(n%2) : void 0;
}

$('body').on('change','input:radio[name=RD1]',function(e){
		var value=/*e.currentTarget.attributes[1].value;*/document.querySelector('input[name="RD1"]:checked').value;
		map.removeLayer(markers);
		markers=L.markerClusterGroup({spiderfyOnMaxZoom: true, showCoverageOnHover: true, zoomToBoundsOnClick: true,maxClusterRadius:50,iconCreateFunction:defineClusterIcon});
		populate($("#1").val(),$("#2").val(),$("#3").val(),$("#4").val(),value);
		}
);

$("#Go").click(function(e){
	
if($("#4").val()==null || $("#4").val()==""){
	alert("Please select indicator");
	return;
}else{
	currentIndicator=$("#4").val();
}

	if(legendAdded){
	legend.removeFrom(map);
}
// if(schoolMarker){
// 		map.removeLayer(schoolMarker);
// 	}
	map.removeLayer(markers);
	markers=L.markerClusterGroup({spiderfyOnMaxZoom: true, showCoverageOnHover: true, zoomToBoundsOnClick: true,maxClusterRadius:50,iconCreateFunction:defineClusterIcon});
var v1=$("#1").val();
var v2=$("#2").val();
var v3=$("#3").val();
var v4=$("#4").val();
// var v5=$("#5").val();

$("#colpanel").empty();
var attributes=getLegendAttributes(currentIndicator);
	var iconAttributes=getIconAttributes(currentIndicator);
    $("#colpanel").append(getLegendHTML(attributes,iconAttributes));

populate(v1,v2,v3,v4);
// renderLegend(v4);



})
// $("#Search").click(function(e){
// 	$("#colpanel").empty();
// 	var code=$("#code").val();
// 	code=code.trim();
// 	if(code==""){
// 	alert("Please enter a school code");
// 	return;
// }else if(schoolCodeExists(code)==null){
// 	alert("Code does not match any school");
// 	return;

// }else if(schoolCodeExists(code)){
// 	var record=schoolCodeExists(code);
// 	map.removeLayer(markers);
// 	// if(schoolMarker){
// 	// 	map.removeLayer(schoolMarker);
// 	// }
// 	map.setView([record.Lat,record.Lon],15);
// 	schoolMarker=L.marker(L.latLng(record.Lat, record.Lon), { icon: orangeIcon});
// 	schoolMarker.bindPopup('<div class ="markerPopup" ><table border="0" cellpadding="1" cellspacing="0" style="width: 300px;border-style:outset;border-color:#000000;"><tbody><tr><td><p><b>School :</b>'+record.School+'</p><p><b>School Code :</b>'+record.School_Code+'</p><p><b>Type :</b>'+ record.Type +'</p><p><b>Category :</b>'+record.Category+'</p><p><a id='+record.School_Code+' class=linktext href=# >Know More</a></p><div id="myDiv" style="display:none"></div></td></tr></tbody></table></div>');
// 	schoolMarker.addTo(map);
// 	// schoolMarkerAdded=true;	
// }
// })

$('#1').change(function(e){
	var selectedValue=this.value;
	populateFilterCombo(selectedValue,'District','#2','Kumban');


})
function schoolCodeExists(code){
for(var j=0;j<origData.length;j++){
	if(origData[j].School_Code==code){
		return origData[j];
	}


}
return null;

}


 function getIndicators(value,firstElementNull,column){
 		var map3={};
 		if(value==""){
 			return map3;
 		}
 		if(firstElementNull==null){
 		map3[0]="";
 	}
 	for(var j=0;j<filterStruct.length;j++){
 		var name3=filterStruct[j].Area;
 		var name2=filterStruct[j].Indicator;
 		var legend= filterStruct[j].Legend;
 		if(name3==value && !(name2 in map3)){
 			map3[name2]=name2;
 		}
 	};
 	return map3;
 }

 function getIndicators(value,firstElementNull){
 		var map3={};
 		if(value==""){
 			return map3;
 		}
 		if(firstElementNull==null){
 		map3[0]="";
 	}
 	for(var j=0;j<filterStruct.length;j++){
 		var name3=filterStruct[j].Area;
 		var name2=filterStruct[j].Indicator;
 		var legend= filterStruct[j].Legend;
 		if(name3==value && !(name2 in map3)){
 			map3[name2]=name2;
 		}
 	};
 	return map3;
 }
 function getPopupIndicators(value,firstElementNull){
 		var map3={};
 		if(value==""){
 			return map3;
 		}
 		if(firstElementNull==null){
 		map3[0]="";
 	}
 	for(var j=0;j<dialogStruct.length;j++){
 		var name3=dialogStruct[j].Area;
 		var name2=dialogStruct[j].Indicator;
 		// var legend= dialogStruct[j].Legend;
 		if(name3==value && !(name2 in map3)){
 			map3[name2]=name2;
 		}
 	};
 	return map3;
 }
 
$("#4").change(function () {
	var selected = $(this).val();
	var tooltip=getTooltip(selected);
	$("#tooltip").empty();
	if(tooltip!=" "){
	$("#tooltip").append(tooltip);
	}
//     var options="";
//     if(selected==""){
//     	$("#4").empty();
//     }else{
//     $.each(getIndicators(selected),function(i,value){
//     		options += '<option value="' + value + '">' + value + '</option>';
//     	$("#4").html(options);

  
// });






});
function getTooltip(selected){

	for(var j=0;j<filterStruct.length;j++){
		if(filterStruct[j].Indicator==selected){
			if(filterStruct[j].Tooltip){
				return filterStruct[j].Tooltip;
			}else{
				return " ";
			}
		}

	}


}


 function populateCombo(selectedValue,target){
var options="";
    if(selectedValue==""){
    	$(target).empty();
    }else{
    $.each(getIndicators(selectedValue),function(i,value){
    		options += '<option value="' + value + '">' + value + '</option>';
    	$(target).html(options);

});

}
}
 function populateFilterCombo(selectedValue,selectedColumn,target,targetColumn){
var options="";
    if(selectedValue==""){
    	$(target).empty();
    }else{
    $.each(getFilters(selectedValue,selectedColumn,targetColumn),function(i,value){
    		options += '<option value="' + value + '">' + value + '</option>';
    	$(target).html(options);

});

}
}
 function populateIslands(){
var options="";
    // if(selectedValue==""){
    // 	$("#1").empty();
    // }
    // else{
    $.each(getIslands(),function(i,value){
    		options += '<option value="' + value + '">' + value + '</option>';
    	$("#1").html(options);

});

// }
}

function sortAlphabetically(obj){
	var keysArray=Object.keys(obj).sort();
	var returnMap={}
	for(var j=0;j<keysArray.length;j++){
		returnMap[obj[keysArray[j]]]=obj[keysArray[j]];
	}

	return returnMap;
}
function getFilters(selectedValue,selectedColumn,targetColumn){
		var map3={};
		var name3;
 		// if(value==""){
 		// 	return map3;
 		// }
 		// if(firstElementNull==null){
 		map3[0]="All";
 	// }
 	for(var j=0;j<origData.length;j++){
 		if(selectedValue !=null){
 		if(selectedValue==origData[j][selectedColumn])
 		name3=origData[j][targetColumn];
 		}else{
 			name3=origData[j][targetColumn];
 		}
 		// var name2=filterStruct[j].Indicator;
 		// var legend= filterStruct[j].Legend;
 		if(name3!=undefined && !(name3 in map3)){
 			map3[name3]=name3;
 		}
 	};
 	
 	return sortAlphabetically(map3);

}
function getPercentage(n,data){
        	percentage={};
        	var sum=0;
			for(var j=0;j<data.length;j++){
				percentage[data[j].key]=parseInt(Math.round((data[j].value/n)*100)).toString();
				sum=sum+parseFloat(percentage[data[j].key]);
				}
			// 	var sum=0;
			// for(var i=0;i<data.length;i++){
			// 	sum=sum+percentage[data[i].key];
			// }	
			if(sum>100){
				percentage[data[data.length-1].key]=(parseInt(percentage[data[data.length-1].key])-(sum-100)).toString();

			}
				return percentage;
			
        }
function defineClusterIcon(cluster){
    // console.log(cluster);
	var children = cluster.getAllChildMarkers(),
        n = children.length, //Get number of markers in cluster
        strokeWidth = 1, //Set clusterpie stroke width
        r = rmax-2*strokeWidth-(n<10?12:n<100?8:n<1000?4:0), //Calculate clusterpie radius...
        iconDim = (r+strokeWidth)*2, //...and divIcon dimensions (leaflet really want to know the size)
        data = d3.nest() //Build a dataset for the pie chart
          .key(function(d) {
          	return d.options.alt; 
          }).entries(children, d3.map),
        getPercentages=function(n,data){
        	percentage={};
        	var sum=0;
			for(var j=0;j<data.length;j++){
				percentage[data[j].key]=parseFloat(Math.round((data[j].values.length/n)*100)).toFixed(2);
				sum=sum+parseFloat(percentage[data[j].key]);
				}
			// 	var sum=0;
			// for(var i=0;i<data.length;i++){
			// 	sum=sum+percentage[data[i].key];
			// }	
			if(sum>100){
				percentage[data[data.length-1].key]=(parseFloat(percentage[data[data.length-1].key])-(sum-100)).toFixed(2);

			}
				return percentage;
			
        },
        percentages=getPercentages(n,data),
        html = bakeThePie({data: data,
                            valueFunc: function(d){return d.values.length;},
                            strokeWidth: 1,
                            outerRadius: r,
                            innerRadius: r-10,
                            pieClass: 'cluster-pie',
                            pieLabel: n,
                            pieLabelClass: 'marker-cluster-pie-label',
                            pathClassFunc: function(d)
                            {var value=d.data.key;
                            	// if(value=="Yes"){
                            	// 	return 'category-3';
                            	// }
                                var iconattributes=getIconAttributes(currentIndicator);
                                var legendAttributes=getLegendAttributes(currentIndicator);
                                var suffix=iconattributes[legendAttributes.indexOf(value)].split(".");
                                return "category-"+suffix[0];

                            },
               pathTitleFunc: function(d){return d.data.key+' ('+d.data.values.length+')'+'('+percentages[d.data.key]+'%)'}
                          }),
        //Create a new divIcon and assign the svg markup to the html property
        myIcon = new L.DivIcon({
            html: html,
            className: 'marker-cluster', 
            iconSize: new L.Point(iconDim, iconDim)
        });
    return myIcon;



}

function bakeThePie(options) {
    /*data and valueFunc are required*/
    if (!options.data || !options.valueFunc) {
        return '';
    }
    var data = options.data,
        valueFunc = options.valueFunc,
        r = options.outerRadius?options.outerRadius:28, //Default outer radius = 28px
        rInner = options.innerRadius?options.innerRadius:r-10, //Default inner radius = r-10
        strokeWidth = options.strokeWidth?options.strokeWidth:1, //Default stroke is 1
        pathClassFunc = options.pathClassFunc?options.pathClassFunc:function(){return '';}, //Class for each path
        pathTitleFunc = options.pathTitleFunc?options.pathTitleFunc:function(){return '';}, //Title for each path
        pieClass = options.pieClass?options.pieClass:'marker-cluster-pie', //Class for the whole pie
        pieLabel = options.pieLabel?options.pieLabel:d3.sum(data,valueFunc), //Label for the whole pie
        pieLabelClass = options.pieLabelClass?options.pieLabelClass:'marker-cluster-pie-label',//Class for the pie label
        
        origo = (r+strokeWidth), //Center coordinate
        w = origo*2, //width and height of the svg element
        h = w,
        donut = d3.layout.pie(),
        arc = d3.svg.arc().innerRadius(rInner).outerRadius(r);
        
    //Create an svg element
    var svg = document.createElementNS(d3.ns.prefix.svg, 'svg');
    //Create the pie chart
    var vis = d3.select(svg)
        .data([data])
        .attr('class', pieClass)
        .attr('width', w)
        .attr('height', h);
        
    var arcs = vis.selectAll('g.arc')
        .data(donut.value(valueFunc))
        .enter().append('svg:g')
        .attr('class', 'arc')
        .attr('transform', 'translate(' + origo + ',' + origo + ')');
    
    arcs.append('svg:path')
        .attr('class', pathClassFunc)
        .attr('stroke-width', strokeWidth)
        .attr('d', arc)
        .append('svg:title')
          .text(pathTitleFunc);
                
    vis.append('text')
        .attr('x',origo)
        .attr('y',origo)
        .attr('class', pieLabelClass)
        .attr('color','red')
        .attr('text-anchor', 'middle')
        //.attr('dominant-baseline', 'central')
        /*IE doesn't seem to support dominant-baseline, but setting dy to .3em does the trick*/
        .attr('dy','.3em')
        .text(pieLabel);
    //Return the svg-markup rather than the actual element
    return serializeXmlNode(svg);
}
function attendanceGraph(record,yaxistext,color,ybound){
var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 300 - margin.left - margin.right,
    height = 300 - margin.top - margin.bottom;

var x0 = d3.scale.ordinal()
    .rangeRoundBands([0, width], .1);

var x1 = d3.scale.ordinal();

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.ordinal()
    .range(color);

var xAxis = d3.svg.axis()
    .scale(x0)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(d3.format(".2s"));

// var tip = d3.tip()
//   .attr('class', 'd3-tip')
//   .offset([-10, 0])
//   .html(function(d) {
//     return "<strong>Frequency:</strong> <span style='color:red'>" + d.value + "</span>";
//   })

var svg = document.createElementNS(d3.ns.prefix.svg, 'svg');


   var vis= d3.select(svg).attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// svg.call(tip);
// d3.csv("test.csv", function(error, data) {

  var data=record;
  var ageNames = d3.keys(data[0]).filter(function(key) { return key !== "Date"; });

  data.forEach(function(d) {
    d.ages = ageNames.map(function(name) { return {name: name, value: +d[name]}; });
  });

  x0.domain(data.map(function(d) { return d.Date; }));
  x1.domain(ageNames).rangeRoundBands([0, x0.rangeBand()]);
  if(!ybound){
  ybound=d3.max(data, function(d) { return d3.max(d.ages, function(d) { return d.value; })})
}
  y.domain([0, ybound]);

  vis.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  vis.append("g")
      .attr("class", "y axis")
      .call(yAxis)
    .append("text")
      .attr("transform", "rotate(-90)")
      // .attr("transform", "translate")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text(yaxistext);

  var state = vis.selectAll(".state")
      .data(data)
    .enter().append("g")
      .attr("class", "g")
      .attr("transform", function(d) { return "translate(" + x0(d.Date) + ",0)"; });

  state.selectAll("rect")
      .data(function(d) { return d.ages; })
    .enter().append("rect")
      
      .attr("width", x1.rangeBand())
      .attr("x", function(d) { return x1(d.name); })
      .attr("y", function(d) { return y(d.value); })
      .attr("height", function(d) { return height - y(d.value); })
      .style("fill", function(d) { return color(d.name); })
      .attr("class","bar")
      .on("mouseover", function() { tooltip.style("display", null); })
  		.on("mouseout", function() { tooltip.style("display", "none"); })
 	 .on("mousemove", function(d) {
    var xPosition = d3.mouse(this)[0] - 15;
    var yPosition = d3.mouse(this)[1] - 25;
    tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
    tooltip.select("text").text(d.value);
  });;

  // state.selectAll(".bar")
  //     .data(data)
  //   .enter().append("rect")
  //     .attr("class", "bar")
  //     .attr("x", function(d) { return x1(d.name); })
  //     .attr("width", x1.rangeBand())
  //     .attr("y", function(d) { return y(d.value); })
  //     .attr("height", function(d) { return height - y(d.value); })
  //     .on('mouseover', tip.show)
  //     .on('mouseout', tip.hide)

  var legend = vis.selectAll(".legend")
      .data(ageNames.slice().reverse())
    .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(20," + i * 20 + ")"; });

  legend.append("rect")
      .attr("x", width - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", color);

  legend.append("text")
      .attr("x", width - 24)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "end")
      .text(function(d) { return d; });

      var tooltip = vis.append("g")
  .attr("class", "tooltip")
  .style("display", "none");
    
tooltip.append("rect")
  .attr("width", 30)
  .attr("height", 20)
  .attr("fill", "white")
  .style("opacity", 0.5);
 
tooltip.append("text")
  .attr("x", 15)
  .attr("dy", "1.2em")
  .style("text-anchor", "middle")
  .attr("font-size", "12px")
  .attr("font-weight", "bold");

      return serializeXmlNode(svg);




}

function pie(options) {
    /*data and valueFunc are required*/
    if (!options.data || !options.valueFunc) {
        return '';
    }
    var data = options.data,
        valueFunc = options.valueFunc,
        r = 100, //Default outer radius = 28px
        rInner = 40, //Default inner radius = r-10
        strokeWidth = 1, //Default stroke is 1
        pathClassFunc = options.pathClassFunc?options.pathClassFunc:function(){return '';}, //Class for each path
        pathTitleFunc = options.pathTitleFunc?options.pathTitleFunc:function(){return '';}, 
        title = options.title?options.title:function(){return '';}, //Title for each path
        pieClass = 'marker-cluster-pie', //Class for the whole pie
        pieLabel = options.Total, //Label for the whole pie
        pieLabelClass = options.pieLabelClass?options.pieLabelClass:'marker-cluster-pie-label',//Class for the pie label
        key=options.key,
        origo = (r+strokeWidth), //Center coordinate
        w = 300, //width and height of the svg element
        h = w,
        donut = d3.layout.pie(),
        arc = d3.svg.arc().innerRadius(rInner).outerRadius(r);
        
    //Create an svg element
    var svg = document.createElementNS(d3.ns.prefix.svg, 'svg');
    //Create the pie chart
    var vis = d3.select(svg)
        .data([data])
        .attr('class', pieClass)
        .attr('width', w)
        .attr('height', h)
        .attr("transform", "translate(10,10)");
        
    var arcs = vis.selectAll('g.arc')
        .data(donut.value(valueFunc))
        .enter().append('svg:g')
        .attr('class', 'arc')
        .attr('transform', 'translate(' + origo + ',' + origo + ')');
    
    arcs.append('svg:path')
        .attr('class', pathClassFunc)
        .attr('stroke-width', strokeWidth)
        .attr('d', arc)
        .append('svg:title')
          .text(pathTitleFunc);

          arcs.append("text")
      .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
      .attr("dy", ".35em")
      .style("text-anchor", "middle")
      .text(title);
                
    vis.append('text')
        .attr('x',origo)
        .attr('y',origo)
        .attr('class', pieLabelClass)
        .attr('color','red')
        .attr('text-anchor', 'middle')
        //.attr('dominant-baseline', 'central')
        /*IE doesn't seem to support dominant-baseline, but setting dy to .3em does the trick*/
        .attr('dy','.3em')
        .text(pieLabel);

   
    //Return the svg-markup rather than the actual element
    return serializeXmlNode(svg);
}
function serializeXmlNode(xmlNode) {
    if (typeof window.XMLSerializer != "undefined") {
        return (new window.XMLSerializer()).serializeToString(xmlNode);
    } else if (typeof xmlNode.xml != "undefined") {
        return xmlNode.xml;
    }
    return "";
}

});
 	</script>
 	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59046568-1', 'auto');
  ga('send', 'pageview');

</script>
 
 </body>
</html>
